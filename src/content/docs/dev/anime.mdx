---
title: (*)点と線
description: スコアを定義して、animationエンジンを作って3次元空間内で多数の点と線を動かす
layout: '../../../layouts/BaseLayout.astro'
---
 <style>{`
        .sl-markdown-content   div.ec-line {
            margin-top: 0 !important;
        }
 `}</style>


# 点と線のためのアニメーションエンジン

## 概要
- 階層構造を持つ点と線の集合を扱いアニメーションさせることを実現したい。
- 汎用的なアニメーションエンジン、スコア記述を検討し実際にサンプルを実装することを目指す




## スコア要件

### スコアの定義
- 全ターゲットに対して一定時間内のアクションを定義した2次元の表をスコアと呼ぶ
- スコアにはbpmを単位としてテンポ属性が含まれる
- スコアには拍子(signature)が分数表記で含まれる
- 一般的な楽譜にはないフレーム長(frame)という概念を導入する
- frameは音符の単位を使ってその長さを表す
- w (全音符)、h (2分音符)、q (4分音符)、e (8分音符)、s (16分音符)、t (32分音符)、x (64分音符)を表すものとする
- 例えばframeは3w5h3s等とあらわされ、その長さを持つことを表す

### ターゲット(tgt)
- ターゲット(tgt)は以下に定義する、実オブジェクト、仮想オブジェクト、ディスプレイを総括してそう呼ぶ
  - 系に含まれるターゲットは配列で管理される

- 点(point)もしくは線(line)であるところの３Dオブジェクトを実オブジェクト(obj)と呼ぶ
　- objは配列として管理される

- 複数のobjを含むまとまりを仮想オブジェクト(vir)と呼ぶ
　- virは配列として管理される

### アクション(A)とふるまい(behavior)
- アクション(A)はターゲットに対する動作を規定する
- アクションは1つ以上のふるまい(behavior)から構成される
- behaviorはframeとパラメータ(bprm)をもって具体的な動きを定義できる
- パラメータは位置、角度、時間、関数とパラメータ、色、輝度等色々な値を取る
- behaviorはtgtに対して、frame時間内での挙動を定義する

```javascript
function behavior(frame,target,prm1,prm2){
  const position=target.getPosition;
  position.x+=
}
```
- 

### スコアイメージ
``` text

bpm:  120
signature: 4/4
+------+------+------+------+------+------+------+------+------+------+------+------+------+------+
| time | frame| obj1 | obj2 | obj3 | obj4 | obj5 | obj6 | vir1 | vir2 | vir3 | vir4 | vir5 | vir6 |
+------+------+------+------+------+------+------+------+------+------+------+------+------+------+
| 0    |  w   |  A1  |  A1  |  A1  |  A1  |  A1  |  A1  |  R   |  R   |  R   |  R   |  R   |  R   |
|      |      |p1,p2 |p3,p4 |p3,p4 |p1,p2 |p5,p6 |p7,p8 |      |      |      |      |      |      |
+------+------+------+------+------+------+------+------+------+------+------+------+------+------+
|  w   |  w   |  A2  |  R   |  A2  |  R   |  A2  |  R   |  A2  |  R   |  R   |  R   |  R   |  A3  | 
|      |      |p1,p2 |      |p3,p4 |      |p5,p6 |      |p7,p8 |      |      |      |      |p9,p0 |
+------+------+------+------+------+------+------+------+------+------+------+------+------+------+
| 2w   |  w2q |  R   |  A2  |  R   |  A2  |  R   |  A2  |  R   |  R   |  R   |  R   |  R   |  A3  |
|      |      |      |      |      |      |      |      |      |      |      |      |      |      |
+------+------+------+------+------+------+------+------+------+------+------+------+------+------+
| 3w2q |  w2q |  A4  |  A4  |  R   |  R   |  R   |  R   |  A5  |  A5  |  R   |  R   |  R   |  R   |
|      |      |      |      |      |      |      |      |      |      |      |      |      |      |
+------+------+------+------+------+------+------+------+------+------+------+------+------+------+
| 5w   |  w   |  C   |  C   |  R   |  R   |  R   |  R   |  L   |  L   |  R   |  R   |  R   |  R   |
|      |      |      |      |      |      |      |      |      |      |      |      |      |      |
+------+------+------+------+------+------+------+------+------+------+------+------+------+------+
| 6w   |  w   |  C   |  C   |  R   |  R   |  R   |  R   |  L   |  L   |  R   |  R   |  R   |  A6  |
|      |      |      |      |      |      |      |      |      |      |      |      |      |      |
+------+------+------+------+------+------+------+------+------+------+------+------+------+------+
 
```
### vir定義イメージ

vir1 := obj1, obj2
vir2 := obj3, obj4
vir3 := obj5, obj6
vir4 := obj1, obj2, obj3
vir5 := obj4, obj5, obj6
vir6 := obj1, obj2, obj3, obj4, obj5, obj6

### アクション定義イメージ
A1 := b1, b2
A2 := b1, b3
A3 := b2, b3, b4
A4 := b1, b3, b5
A5 := b4, b5, b6

## シーンの構造
想定するシーンを説明する。これは一例に過ぎない
- ある3DオブジェクトをN1個、別の3DオブジェクトをN2個含むようなグループをG1とする
- G2,G3,G4というグループが存在するとする
- G1～G4までをまとめてGとする
- G以外に一つのカメラ、複数の光源、を含むようなシーングラフを想定する

## プログラムのアーキテクチャ
- 3Dオブジェクトの数はアニメーション中に変化するのでファクトリーモデルを想定する
- AnimationObject: 全ての３Dオブジェクトの共通的な汎用型とする
- AnimationObjectのファクトリー型を定義する
- １つ種類の１つのの3Dオブジェクトに対応する型を汎用型から継承された型として定義する
- 

## アニメーションエンジン

設計の指示文
アニメーション開始時の状態記録:

アニメーションを開始する際、オブジェクトの現在の位置、スケール、回転（世界座標系）を記録。
アニメーションの残り時間（カウントダウン）を指定し、動作ロジック（メソッドとパラメータ）を登録する。
アニメーション進行の制御:

各フレームでカウントダウンを減少。
カウントダウンが正の間、動作ロジックを実行して位置、スケール、回転を計算し、オブジェクトに適用。
動作ロジックの役割:

動作ロジックは、任意の時間における位置、スケール、回転を計算。
ロジックは開始時の状態を考慮して計算を行う。
アニメーション終了後の状態:

カウントダウンが0以下になった場合、アニメーションを停止。
次のアニメーションが設定されるまで、オブジェクトは静止状態になる。


## 技術
