---
title: f) Perlinノイズ
description: 基本的な説明
layout: '../../../layouts/BaseLayout.astro'
---
## 概論
- N次元空間のセルの間で滑らかにつながることを保証されたノイズの関数を発生させる手法
- 滑らかさの観点では常に５次のスプライン関数$fade(t)=6t^5-15t^4+10t^3$を用いる
- セルをつなぐグリッド点では、傾きを生成するためにハッシュ関数$h_i=h(i)$を用いる
  - $h_i=h(i)$はパフォーマンスとランダム性の特性に依拠しユーザが個別に定義する必要がある
- グリッド点の傾きをハッシュ値から傾きを生成する$g_i=grad(h_i)$は
  - $g_i=grad(h_i)$はノイズの性質を左右するためユーザが目的の応じて定義する必要がある

### 生成プロセス
以下の5ステップでノイズ関数が作成できる。ただし、次元が高くなると
1. N次元の領域を想定し、そこに属する任意の点$x$のノイズを求めることを目標とする
2. 領域を整数倍のN次元のグリッドに区切る
3. 任意の点はその点を囲うN次元のグリッド点によって囲まれている
4. 各グリッド点でランダムな値をユーザが定義したN次元のハッシュ関数で割り当てる
5. グリッド点に設定されたベクトル値に応じて点の値は影響を受けると想定し、lerpするのだが、<u>直接の値でlerpせずにfade関数を用いて中間点を補正しlerpするのがポイント</u>である。イメージとしては、各次元ごとに任意の点$x$の小数部を用いて次元をひとつづつ落としながら集約して計算する。
   - 2次元の例
     - 各グリッド位置でのgrad(傾き)を$dot_{00}, dot_{01}, dot_{10}, dot_{11}$とする。
     - ｘ方向の補間は4点のグリッド点から2点作られる
     $$
      x_1 =lerp(dot_{00},dot_{10},fade( \trunc(x) ))\\
      x_2 =lerp(dot_{01},dot_{11},fade( \trunc(x) ))\\
     $$
     
     $$
      lerp(a,b,t) = (1-t) \cdot a+t \cdot b
     $$
     この二つのx方向補完点はy方向にずれているためy方向で最後補間すると目的の関数が得られる。すなわち、
     $$
      P(x)=lerp(x_1,x_2,fade( \trunc(y) ))
     $$
     y方向で補間してから最後にx方向で補間しても同じ結果が得られる（そうである）。

### 勾配関数の例
グリッド点のハッシュ値$h=h(i)$の値を使って勾配を求める
- 符号のみ。単純さを優先
$$
 grad(h)=(-1)^{(h \mod 2)}
$$
- 符号とスケール
$$
 grad(h)=(-1)^{(h \mod 2)} \cdot ( (h \mod 8) +1)
$$
- 符号と別のスケール、ランダム性が増し細かい調整が可能。勾配の大きさを0.25,0.5,0.75,1.0 にスケール
$$
 grad(h)=(-1)^{(h \mod 2)} \cdot \frac{ (h \mod 4) +1}{4}
$$
- 三角関数。なめらかで連続的な変動（例: 波状のパターン）
$$
 grad(h)=sin(h \cdot \frac{\pi}{8} )
$$
- 三角関数の組み合わせ、より複雑で連続的
$$
 grad(h)=cos(h \cdot \frac{\pi}{4} ) + sin( h \cdot \frac{\pi}{8})
$$
- 三角関数で位相を持つ。なめらかでランダム。
$$
 grad(h)=cos(h \cdot \frac{\pi}{8} ) \cdot (-1)^{(h \mod 2)}
$$
- フラクタル性、小さいhで細かい変動、大きいhで緩やかな高スケールの変動
$$
 grad(h)=\frac{sin(h)}{h+1}
$$
- 他のフラクタル性のある例、指数的減衰
$$
 grad(h)=sin(h) \cdot e^{-h}
$$
- 他のフラクタル性のある例、フラクタルブラウン運動を模倣
$$
 grad(h)=\frac{sin(h)}{\sqrt{h+1}}
$$
- 他のフラクタル性のある例、異なる成分
$$
 grad(h)=sin(h)+\frac{sin(2h)}{2}+\frac{sin(4h)}{4}
$$
- 他のPerlinノイズを使う
$$
 grad(h)=PerlinNoise(h) \cdot \frac{1}{h+1}
$$
- ロジスティック曲線を使う
$$
 grad(h)=\frac{sin(h)}{1+e^h}
$$
- ハッシュ値を直接スケールとして使用
$$
 grad(h)=\frac{(h \mod 16)}{16}
$$


### ハッシュ関数の例

- シンプルで高速なハッシュ関数
$$
 hash(i) = (i\cdot57+13) \mod 256
$$
- xorでランダム性を強める,再現性を保つ   
$$
 hash(i) = ((i \oplus 12345) \cdot 57 + 13 ) \mod 256
$$
- 計算が高速
$$
 hash(i) = ((i \cdot 31) \gg 3 ) \mod 256
$$
- 三角関数
  -  fracは小数部分を取得する関数
$$
 hash(i) = floor(256 \cdot frac(sin(i) \cdot 12345 ))
$$
- 乱数テーブルを事前に作る
$$
 hash(i) = perm[i \mod N]
$$
- ポリノミアル関数
$$
 hash(i) = (i^3+31i+7) \mod 256
$$

